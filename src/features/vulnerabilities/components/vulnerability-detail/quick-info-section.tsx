'use client';

import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle
} from '@/components/ui/card';
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger
} from '@/components/ui/accordion';
import { Badge } from '@/components/ui/badge';
import {
  MapPin,
  Target,
  ShieldCheck,
  Users,
  Clock,
  Code2,
  Database,
  Network,
  FileText,
  AlertTriangle
} from 'lucide-react';
import { VulnerabilityDTO } from '../../types';

interface QuickInfoSectionProps {
  vulnerability: VulnerabilityDTO;
  isEditing?: boolean;
}

export function QuickInfoSection({
  vulnerability,
  isEditing = false
}: QuickInfoSectionProps) {
  return (
    <Card>
      <CardHeader>
        <div className='flex items-center gap-2'>
          <Target className='text-muted-foreground h-5 w-5' />
          <CardTitle>快速信息</CardTitle>
        </div>
        <CardDescription>漏洞的关键技术细节和影响评估</CardDescription>
      </CardHeader>
      <CardContent>
        <Accordion
          type='multiple'
          defaultValue={['location', 'impact']}
          className='w-full'
        >
          {/* 漏洞位置信息 */}
          <AccordionItem value='location'>
            <AccordionTrigger className='hover:no-underline'>
              <div className='flex items-center gap-2'>
                <MapPin className='h-4 w-4' />
                <span>漏洞位置</span>
                <Badge variant='outline' className='ml-2'>
                  技术细节
                </Badge>
              </div>
            </AccordionTrigger>
            <AccordionContent>
              <div className='space-y-4 pt-2'>
                {/* 受影响模块 */}
                {vulnerability.affectedModule && (
                  <div className='flex items-start gap-3'>
                    <Code2 className='text-muted-foreground mt-1 h-4 w-4' />
                    <div className='flex-1'>
                      <div className='mb-1 text-sm font-medium'>受影响模块</div>
                      <div className='text-muted-foreground bg-muted rounded px-2 py-1 font-mono text-sm'>
                        {vulnerability.affectedModule}
                      </div>
                    </div>
                  </div>
                )}

                {/* 受影响端点 */}
                {vulnerability.affectedEndpoint && (
                  <div className='flex items-start gap-3'>
                    <Network className='text-muted-foreground mt-1 h-4 w-4' />
                    <div className='flex-1'>
                      <div className='mb-1 text-sm font-medium'>受影响端点</div>
                      <div className='text-muted-foreground bg-muted rounded px-2 py-1 font-mono text-sm'>
                        {vulnerability.affectedEndpoint}
                      </div>
                    </div>
                  </div>
                )}

                {/* 受影响参数 */}
                {vulnerability.affectedParameter && (
                  <div className='flex items-start gap-3'>
                    <Database className='text-muted-foreground mt-1 h-4 w-4' />
                    <div className='flex-1'>
                      <div className='mb-1 text-sm font-medium'>受影响参数</div>
                      <div className='text-muted-foreground bg-muted rounded px-2 py-1 font-mono text-sm'>
                        {vulnerability.affectedParameter}
                      </div>
                    </div>
                  </div>
                )}

                {/* 如果没有位置信息 */}
                {!vulnerability.affectedModule &&
                  !vulnerability.affectedEndpoint &&
                  !vulnerability.affectedParameter && (
                    <div className='text-muted-foreground flex items-center gap-2 text-sm'>
                      <AlertTriangle className='h-4 w-4' />
                      位置信息待完善
                    </div>
                  )}
              </div>
            </AccordionContent>
          </AccordionItem>

          {/* 影响评估 */}
          <AccordionItem value='impact'>
            <AccordionTrigger className='hover:no-underline'>
              <div className='flex items-center gap-2'>
                <AlertTriangle className='h-4 w-4' />
                <span>影响评估</span>
                <Badge variant='outline' className='ml-2'>
                  风险分析
                </Badge>
              </div>
            </AccordionTrigger>
            <AccordionContent>
              <div className='space-y-4 pt-2'>
                {/* 漏洞影响描述 */}
                {vulnerability.impact && (
                  <div className='space-y-2'>
                    <div className='text-sm font-medium'>影响描述</div>
                    <div className='text-muted-foreground text-sm leading-relaxed'>
                      {vulnerability.impact}
                    </div>
                  </div>
                )}

                {/* CVSS评分详情 */}
                {vulnerability.cvssVector && (
                  <div className='space-y-2'>
                    <div className='text-sm font-medium'>CVSS向量</div>
                    <div className='text-muted-foreground bg-muted rounded px-2 py-1 font-mono text-sm text-xs'>
                      {vulnerability.cvssVector}
                    </div>
                  </div>
                )}

                {/* 可利用性评估 */}
                {vulnerability.exploitability && (
                  <div className='flex items-center gap-3'>
                    <ShieldCheck className='text-muted-foreground h-4 w-4' />
                    <div className='flex-1'>
                      <div className='mb-1 text-sm font-medium'>可利用性</div>
                      <Badge
                        variant={
                          vulnerability.exploitability === 'FUNCTIONAL'
                            ? 'destructive'
                            : vulnerability.exploitability === 'POC'
                              ? 'default'
                              : 'secondary'
                        }
                      >
                        {vulnerability.exploitability === 'FUNCTIONAL'
                          ? '功能性'
                          : vulnerability.exploitability === 'POC'
                            ? '概念验证'
                            : vulnerability.exploitability === 'THEORETICAL'
                              ? '理论性'
                              : '未知'}
                      </Badge>
                    </div>
                  </div>
                )}

                {/* 如果没有影响信息 */}
                {!vulnerability.impact &&
                  !vulnerability.cvssVector &&
                  !vulnerability.exploitability && (
                    <div className='text-muted-foreground flex items-center gap-2 text-sm'>
                      <AlertTriangle className='h-4 w-4' />
                      影响评估待完善
                    </div>
                  )}
              </div>
            </AccordionContent>
          </AccordionItem>

          {/* 修复建议 */}
          <AccordionItem value='remediation'>
            <AccordionTrigger className='hover:no-underline'>
              <div className='flex items-center gap-2'>
                <ShieldCheck className='h-4 w-4' />
                <span>修复建议</span>
                <Badge variant='outline' className='ml-2'>
                  解决方案
                </Badge>
              </div>
            </AccordionTrigger>
            <AccordionContent>
              <div className='space-y-4 pt-2'>
                {/* 修复建议 */}
                {vulnerability.recommendation && (
                  <div className='space-y-2'>
                    <div className='text-sm font-medium'>修复建议</div>
                    <div className='text-muted-foreground rounded-md border border-green-200 bg-green-50 p-3 text-sm leading-relaxed dark:border-green-800 dark:bg-green-950/20'>
                      {vulnerability.recommendation}
                    </div>
                  </div>
                )}

                {/* 临时解决方案 */}
                {vulnerability.workaround && (
                  <div className='space-y-2'>
                    <div className='text-sm font-medium'>临时解决方案</div>
                    <div className='text-muted-foreground rounded-md border border-yellow-200 bg-yellow-50 p-3 text-sm leading-relaxed dark:border-yellow-800 dark:bg-yellow-950/20'>
                      {vulnerability.workaround}
                    </div>
                  </div>
                )}

                {/* 参考资料 */}
                {vulnerability.references && (
                  <div className='space-y-2'>
                    <div className='flex items-center gap-2 text-sm font-medium'>
                      <FileText className='h-4 w-4' />
                      参考资料
                    </div>
                    <div className='text-muted-foreground text-sm leading-relaxed'>
                      {vulnerability.references}
                    </div>
                  </div>
                )}

                {/* 如果没有修复信息 */}
                {!vulnerability.recommendation &&
                  !vulnerability.workaround &&
                  !vulnerability.references && (
                    <div className='text-muted-foreground flex items-center gap-2 text-sm'>
                      <AlertTriangle className='h-4 w-4' />
                      修复方案待制定
                    </div>
                  )}
              </div>
            </AccordionContent>
          </AccordionItem>

          {/* 人员与时间 */}
          <AccordionItem value='people-time'>
            <AccordionTrigger className='hover:no-underline'>
              <div className='flex items-center gap-2'>
                <Users className='h-4 w-4' />
                <span>人员与时间</span>
                <Badge variant='outline' className='ml-2'>
                  协作信息
                </Badge>
              </div>
            </AccordionTrigger>
            <AccordionContent>
              <div className='space-y-4 pt-2'>
                {/* 发现人员 */}
                <div className='flex items-center gap-3'>
                  <div className='flex h-8 w-8 items-center justify-center rounded-full bg-blue-100 dark:bg-blue-900/20'>
                    <Users className='h-4 w-4 text-blue-600 dark:text-blue-400' />
                  </div>
                  <div className='flex-1'>
                    <div className='text-sm font-medium'>发现人员</div>
                    <div className='text-muted-foreground text-sm'>
                      {vulnerability.foundByUser
                        ? vulnerability.foundByUser.name ||
                          vulnerability.foundByUser.email
                        : '系统记录'}
                    </div>
                  </div>
                </div>

                {/* 确认人员 */}
                {vulnerability.confirmedByUser && (
                  <div className='flex items-center gap-3'>
                    <div className='flex h-8 w-8 items-center justify-center rounded-full bg-green-100 dark:bg-green-900/20'>
                      <ShieldCheck className='h-4 w-4 text-green-600 dark:text-green-400' />
                    </div>
                    <div className='flex-1'>
                      <div className='text-sm font-medium'>确认人员</div>
                      <div className='text-muted-foreground text-sm'>
                        {vulnerability.confirmedByUser.name ||
                          vulnerability.confirmedByUser.email}
                      </div>
                    </div>
                  </div>
                )}

                {/* 验证人员 */}
                {vulnerability.verifiedByUser && (
                  <div className='flex items-center gap-3'>
                    <div className='flex h-8 w-8 items-center justify-center rounded-full bg-purple-100 dark:bg-purple-900/20'>
                      <Clock className='h-4 w-4 text-purple-600 dark:text-purple-400' />
                    </div>
                    <div className='flex-1'>
                      <div className='text-sm font-medium'>验证人员</div>
                      <div className='text-muted-foreground text-sm'>
                        {vulnerability.verifiedByUser.name ||
                          vulnerability.verifiedByUser.email}
                      </div>
                    </div>
                  </div>
                )}

                {/* CVE和OWASP信息 */}
                {(vulnerability.cveId || vulnerability.owaspId) && (
                  <div className='border-t pt-2'>
                    <div className='mb-2 text-sm font-medium'>外部标识</div>
                    <div className='flex flex-wrap gap-2'>
                      {vulnerability.cveId && (
                        <Badge
                          variant='secondary'
                          className='font-mono text-xs'
                        >
                          CVE: {vulnerability.cveId}
                        </Badge>
                      )}
                      {vulnerability.owaspId && (
                        <Badge
                          variant='secondary'
                          className='font-mono text-xs'
                        >
                          OWASP: {vulnerability.owaspId}
                        </Badge>
                      )}
                    </div>
                  </div>
                )}
              </div>
            </AccordionContent>
          </AccordionItem>
        </Accordion>
      </CardContent>
    </Card>
  );
}
