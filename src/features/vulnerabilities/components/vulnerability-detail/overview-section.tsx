'use client';

import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle
} from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Separator } from '@/components/ui/separator';
import { Progress } from '@/components/ui/progress';
import {
  Shield,
  TrendingUp,
  Users,
  Database,
  CheckCircle,
  Clock,
  AlertCircle,
  XCircle
} from 'lucide-react';
import {
  VulnerabilityDTO,
  VulnerabilitySeverity,
  VulnerabilityStatus
} from '../../types';
import {
  VULNERABILITY_SEVERITY_OPTIONS,
  VULNERABILITY_STATUS_OPTIONS,
  getColorByValue
} from '../vulnerability-tables/options';
import { format } from 'date-fns';
import { zhCN } from 'date-fns/locale';

interface OverviewSectionProps {
  vulnerability: VulnerabilityDTO;
  isEditing?: boolean;
}

// 严重程度到数值的映射（用于进度条）
const severityScores: Record<VulnerabilitySeverity, number> = {
  CRITICAL: 100,
  HIGH: 80,
  MEDIUM: 60,
  LOW: 40,
  INFO: 20
};

// 状态图标映射
const statusIcons = {
  OPEN: AlertCircle,
  CONFIRMED: AlertCircle,
  IN_PROGRESS: Clock,
  FIXED: CheckCircle,
  VERIFIED: CheckCircle,
  REOPEN: AlertCircle,
  WONT_FIX: XCircle,
  FALSE_POSITIVE: XCircle,
  DUPLICATE: XCircle,
  ACCEPTED_RISK: CheckCircle
};

export function OverviewSection({
  vulnerability,
  isEditing = false
}: OverviewSectionProps) {
  const severityColor = getColorByValue(
    VULNERABILITY_SEVERITY_OPTIONS,
    vulnerability.severity
  );
  const statusColor = getColorByValue(
    VULNERABILITY_STATUS_OPTIONS,
    vulnerability.status
  );
  const severityScore = severityScores[vulnerability.severity];

  const severityOption = VULNERABILITY_SEVERITY_OPTIONS.find(
    (opt) => opt.value === vulnerability.severity
  );
  const statusOption = VULNERABILITY_STATUS_OPTIONS.find(
    (opt) => opt.value === vulnerability.status
  );
  const StatusIcon = statusIcons[vulnerability.status];

  return (
    <Card>
      <CardHeader>
        <div className='flex items-center gap-2'>
          <Shield className='text-muted-foreground h-5 w-5' />
          <CardTitle>漏洞概览</CardTitle>
        </div>
        <CardDescription>漏洞的基本信息和关键指标</CardDescription>
      </CardHeader>
      <CardContent className='space-y-6'>
        {/* 漏洞描述 */}
        <div className='space-y-2'>
          <div className='flex flex-wrap items-center gap-3'>
            <Badge
              className='px-3 py-1 text-xs font-medium'
              style={{ backgroundColor: severityColor, color: 'white' }}
            >
              {severityOption?.label}
            </Badge>
            <Badge
              variant='outline'
              className='gap-1 px-3 py-1 text-xs'
              style={{ borderColor: statusColor, color: statusColor }}
            >
              <StatusIcon className='h-3 w-3' />
              {statusOption?.label}
            </Badge>
            {vulnerability.category && (
              <Badge variant='secondary' className='text-xs'>
                {vulnerability.category.name}
              </Badge>
            )}
          </div>

          <p className='text-muted-foreground leading-relaxed'>
            {vulnerability.description}
          </p>
        </div>

        <Separator />

        {/* 关键指标Dashboard */}
        <div className='grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-4'>
          {/* CVSS评分 */}
          <div className='space-y-3 rounded-lg border p-4'>
            <div className='flex items-center justify-between'>
              <div className='flex items-center gap-2'>
                <Shield className='text-muted-foreground h-4 w-4' />
                <span className='text-sm font-medium'>CVSS评分</span>
              </div>
            </div>
            {vulnerability.cvssScore ? (
              <div className='space-y-2'>
                <div className='text-2xl font-bold'>
                  {vulnerability.cvssScore.toFixed(1)}
                </div>
                <Progress
                  value={vulnerability.cvssScore * 10}
                  className='h-2'
                />
                <div className='text-muted-foreground text-xs'>
                  {vulnerability.cvssVersion &&
                    `CVSS ${vulnerability.cvssVersion}`}
                </div>
              </div>
            ) : (
              <div className='text-muted-foreground text-sm'>暂未评分</div>
            )}
          </div>

          {/* 业务影响 */}
          <div className='space-y-3 rounded-lg border p-4'>
            <div className='flex items-center gap-2'>
              <TrendingUp className='text-muted-foreground h-4 w-4' />
              <span className='text-sm font-medium'>业务影响</span>
            </div>
            <div className='space-y-1'>
              <div className='text-xl font-semibold'>
                {vulnerability.businessImpact ? (
                  <Badge
                    variant={
                      vulnerability.businessImpact === 'CRITICAL'
                        ? 'destructive'
                        : vulnerability.businessImpact === 'HIGH'
                          ? 'destructive'
                          : vulnerability.businessImpact === 'MEDIUM'
                            ? 'default'
                            : 'secondary'
                    }
                  >
                    {vulnerability.businessImpact === 'CRITICAL'
                      ? '严重'
                      : vulnerability.businessImpact === 'HIGH'
                        ? '高'
                        : vulnerability.businessImpact === 'MEDIUM'
                          ? '中等'
                          : vulnerability.businessImpact === 'LOW'
                            ? '较低'
                            : '无'}
                  </Badge>
                ) : (
                  <span className='text-muted-foreground text-sm'>待评估</span>
                )}
              </div>
            </div>
          </div>

          {/* 影响用户数 */}
          <div className='space-y-3 rounded-lg border p-4'>
            <div className='flex items-center gap-2'>
              <Users className='text-muted-foreground h-4 w-4' />
              <span className='text-sm font-medium'>影响用户</span>
            </div>
            <div className='space-y-1'>
              <div className='text-xl font-semibold'>
                {vulnerability.affectedUsers
                  ? vulnerability.affectedUsers.toLocaleString()
                  : '未知'}
              </div>
              {vulnerability.affectedUsers && (
                <div className='text-muted-foreground text-xs'>个用户账户</div>
              )}
            </div>
          </div>

          {/* 数据暴露级别 */}
          <div className='space-y-3 rounded-lg border p-4'>
            <div className='flex items-center gap-2'>
              <Database className='text-muted-foreground h-4 w-4' />
              <span className='text-sm font-medium'>数据暴露</span>
            </div>
            <div className='space-y-1'>
              <div className='text-sm font-medium'>
                {vulnerability.dataExposure ? (
                  <Badge
                    variant={
                      vulnerability.dataExposure === 'SENSITIVE'
                        ? 'destructive'
                        : vulnerability.dataExposure === 'PII'
                          ? 'destructive'
                          : vulnerability.dataExposure === 'INTERNAL'
                            ? 'default'
                            : 'secondary'
                    }
                  >
                    {vulnerability.dataExposure === 'SENSITIVE'
                      ? '敏感数据'
                      : vulnerability.dataExposure === 'PII'
                        ? '个人信息'
                        : vulnerability.dataExposure === 'INTERNAL'
                          ? '内部数据'
                          : vulnerability.dataExposure === 'PUBLIC'
                            ? '公开数据'
                            : '无'}
                  </Badge>
                ) : (
                  <span className='text-muted-foreground'>待确认</span>
                )}
              </div>
            </div>
          </div>
        </div>

        <Separator />

        {/* 状态时间线 */}
        <div className='space-y-3'>
          <h4 className='flex items-center gap-2 text-sm font-medium'>
            <Clock className='h-4 w-4' />
            时间线
          </h4>

          <div className='flex items-center gap-2 overflow-x-auto pb-2'>
            {/* 发现 */}
            <div className='flex min-w-0 flex-col items-center gap-1'>
              <div
                className={`flex h-8 w-8 items-center justify-center rounded-full text-xs font-medium text-white`}
                style={{ backgroundColor: '#22c55e' }}
              >
                1
              </div>
              <div className='text-xs font-medium'>发现</div>
              <div className='text-muted-foreground text-center text-xs'>
                {format(new Date(vulnerability.foundDate), 'MM-dd', {
                  locale: zhCN
                })}
              </div>
            </div>

            <div className='bg-border h-px min-w-4 flex-1'></div>

            {/* 确认 */}
            <div className='flex min-w-0 flex-col items-center gap-1'>
              <div
                className={`flex h-8 w-8 items-center justify-center rounded-full text-xs font-medium ${
                  vulnerability.confirmedAt
                    ? 'bg-blue-500 text-white'
                    : 'bg-muted text-muted-foreground'
                }`}
              >
                2
              </div>
              <div className='text-xs font-medium'>确认</div>
              <div className='text-muted-foreground text-center text-xs'>
                {vulnerability.confirmedAt
                  ? format(new Date(vulnerability.confirmedAt), 'MM-dd', {
                      locale: zhCN
                    })
                  : '待确认'}
              </div>
            </div>

            <div className='bg-border h-px min-w-4 flex-1'></div>

            {/* 修复 */}
            <div className='flex min-w-0 flex-col items-center gap-1'>
              <div
                className={`flex h-8 w-8 items-center justify-center rounded-full text-xs font-medium ${
                  vulnerability.fixedAt
                    ? 'bg-orange-500 text-white'
                    : 'bg-muted text-muted-foreground'
                }`}
              >
                3
              </div>
              <div className='text-xs font-medium'>修复</div>
              <div className='text-muted-foreground text-center text-xs'>
                {vulnerability.fixedAt
                  ? format(new Date(vulnerability.fixedAt), 'MM-dd', {
                      locale: zhCN
                    })
                  : '待修复'}
              </div>
            </div>

            <div className='bg-border h-px min-w-4 flex-1'></div>

            {/* 验证 */}
            <div className='flex min-w-0 flex-col items-center gap-1'>
              <div
                className={`flex h-8 w-8 items-center justify-center rounded-full text-xs font-medium ${
                  vulnerability.verifiedAt
                    ? 'bg-green-500 text-white'
                    : 'bg-muted text-muted-foreground'
                }`}
              >
                4
              </div>
              <div className='text-xs font-medium'>验证</div>
              <div className='text-muted-foreground text-center text-xs'>
                {vulnerability.verifiedAt
                  ? format(new Date(vulnerability.verifiedAt), 'MM-dd', {
                      locale: zhCN
                    })
                  : '待验证'}
              </div>
            </div>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
