'use client';

import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle
} from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Separator } from '@/components/ui/separator';
import {
  Code2,
  FileText,
  Users,
  MessageSquare,
  Bug,
  Database,
  Network,
  Eye,
  Download,
  Upload
} from 'lucide-react';
import { VulnerabilityDTO } from '../../types';
import { RichContentViewer } from '@/components/ui/rich-content-viewer';
import { useVulnerabilityComments } from '../../hooks/useVulnerabilityComments';

interface DetailTabsProps {
  vulnerability: VulnerabilityDTO;
  isEditing?: boolean;
}

export function DetailTabs({
  vulnerability,
  isEditing = false
}: DetailTabsProps) {
  // 获取评论统计信息
  const { stats: commentStats } = useVulnerabilityComments({
    vulnerabilityId: vulnerability.id,
    includeReplies: true,
    sortOrder: 'desc',
    limit: 0 // 只获取统计信息，不需要评论内容
  });

  return (
    <Card>
      <CardHeader>
        <CardTitle className='flex items-center gap-2'>
          <FileText className='text-muted-foreground h-5 w-5' />
          技术详情
        </CardTitle>
        <CardDescription>漏洞的完整技术文档和协作信息</CardDescription>
      </CardHeader>
      <CardContent>
        <Tabs defaultValue='technical' className='w-full'>
          <TabsList className='grid w-full grid-cols-4'>
            <TabsTrigger value='technical' className='gap-1'>
              <Code2 className='h-4 w-4' />
              技术分析
            </TabsTrigger>
            <TabsTrigger value='proof' className='gap-1'>
              <Bug className='h-4 w-4' />
              概念验证
            </TabsTrigger>
            <TabsTrigger value='documents' className='gap-1'>
              <FileText className='h-4 w-4' />
              文档资料
            </TabsTrigger>
            <TabsTrigger value='collaboration' className='gap-1'>
              <Users className='h-4 w-4' />
              协作记录
            </TabsTrigger>
          </TabsList>

          {/* 技术分析 */}
          <TabsContent value='technical' className='mt-6 space-y-6'>
            {/* 复现步骤 */}
            <div className='space-y-4'>
              <div className='flex items-center gap-2'>
                <Eye className='text-muted-foreground h-4 w-4' />
                <h3 className='text-lg font-semibold'>复现步骤</h3>
              </div>
              {vulnerability.reproductionSteps ? (
                <div className='bg-muted/30 rounded-lg border p-4'>
                  <RichContentViewer
                    content={vulnerability.reproductionSteps}
                  />
                </div>
              ) : (
                <div className='text-muted-foreground text-sm italic'>
                  复现步骤尚未记录
                </div>
              )}
            </div>

            <Separator />

            {/* 请求响应数据 */}
            <div className='grid gap-6 lg:grid-cols-2'>
              {/* 请求数据 */}
              <div className='space-y-3'>
                <div className='flex items-center gap-2'>
                  <Upload className='text-muted-foreground h-4 w-4' />
                  <h4 className='font-medium'>请求数据</h4>
                </div>
                {vulnerability.requestData ? (
                  <div className='bg-muted rounded-md p-3'>
                    <pre className='overflow-x-auto font-mono text-sm whitespace-pre-wrap'>
                      {vulnerability.requestData}
                    </pre>
                  </div>
                ) : (
                  <div className='text-muted-foreground text-sm italic'>
                    无请求数据记录
                  </div>
                )}
              </div>

              {/* 响应数据 */}
              <div className='space-y-3'>
                <div className='flex items-center gap-2'>
                  <Download className='text-muted-foreground h-4 w-4' />
                  <h4 className='font-medium'>响应数据</h4>
                </div>
                {vulnerability.responseData ? (
                  <div className='bg-muted rounded-md p-3'>
                    <pre className='overflow-x-auto font-mono text-sm whitespace-pre-wrap'>
                      {vulnerability.responseData}
                    </pre>
                  </div>
                ) : (
                  <div className='text-muted-foreground text-sm italic'>
                    无响应数据记录
                  </div>
                )}
              </div>
            </div>

            <Separator />

            {/* 技术细节汇总 */}
            <div className='space-y-4'>
              <h4 className='flex items-center gap-2 font-medium'>
                <Database className='h-4 w-4' />
                技术细节汇总
              </h4>
              <div className='grid gap-4 sm:grid-cols-2 lg:grid-cols-3'>
                {vulnerability.affectedModule && (
                  <div className='space-y-1'>
                    <div className='text-muted-foreground text-sm font-medium'>
                      受影响模块
                    </div>
                    <Badge variant='outline' className='font-mono text-xs'>
                      {vulnerability.affectedModule}
                    </Badge>
                  </div>
                )}
                {vulnerability.affectedEndpoint && (
                  <div className='space-y-1'>
                    <div className='text-muted-foreground text-sm font-medium'>
                      受影响端点
                    </div>
                    <Badge variant='outline' className='font-mono text-xs'>
                      {vulnerability.affectedEndpoint}
                    </Badge>
                  </div>
                )}
                {vulnerability.affectedParameter && (
                  <div className='space-y-1'>
                    <div className='text-muted-foreground text-sm font-medium'>
                      受影响参数
                    </div>
                    <Badge variant='outline' className='font-mono text-xs'>
                      {vulnerability.affectedParameter}
                    </Badge>
                  </div>
                )}
                {vulnerability.cvssVector && (
                  <div className='space-y-1'>
                    <div className='text-muted-foreground text-sm font-medium'>
                      CVSS向量
                    </div>
                    <Badge variant='secondary' className='font-mono text-xs'>
                      {vulnerability.cvssVersion || 'v3.1'}
                    </Badge>
                  </div>
                )}
                {vulnerability.cveId && (
                  <div className='space-y-1'>
                    <div className='text-muted-foreground text-sm font-medium'>
                      CVE编号
                    </div>
                    <Badge variant='secondary' className='font-mono text-xs'>
                      {vulnerability.cveId}
                    </Badge>
                  </div>
                )}
                {vulnerability.owaspId && (
                  <div className='space-y-1'>
                    <div className='text-muted-foreground text-sm font-medium'>
                      OWASP分类
                    </div>
                    <Badge variant='secondary' className='font-mono text-xs'>
                      {vulnerability.owaspId}
                    </Badge>
                  </div>
                )}
              </div>
            </div>
          </TabsContent>

          {/* 概念验证 */}
          <TabsContent value='proof' className='mt-6 space-y-6'>
            <div className='space-y-4'>
              <div className='flex items-center gap-2'>
                <Bug className='text-muted-foreground h-4 w-4' />
                <h3 className='text-lg font-semibold'>概念验证 (PoC)</h3>
              </div>
              {vulnerability.proofOfConcept ? (
                <div className='bg-muted/30 rounded-lg border p-4'>
                  <RichContentViewer content={vulnerability.proofOfConcept} />
                </div>
              ) : (
                <div className='text-muted-foreground text-sm italic'>
                  PoC尚未提供
                </div>
              )}
            </div>

            {(vulnerability.requestData || vulnerability.responseData) && (
              <>
                <Separator />
                <div className='space-y-4'>
                  <h4 className='font-medium'>相关数据包</h4>
                  <div className='grid gap-4 lg:grid-cols-2'>
                    {vulnerability.requestData && (
                      <div className='space-y-2'>
                        <div className='text-sm font-medium text-green-600 dark:text-green-400'>
                          攻击载荷 (Request)
                        </div>
                        <div className='rounded-md border border-green-200 bg-green-50 p-3 dark:border-green-800 dark:bg-green-950/20'>
                          <pre className='overflow-x-auto font-mono text-xs whitespace-pre-wrap'>
                            {vulnerability.requestData}
                          </pre>
                        </div>
                      </div>
                    )}
                    {vulnerability.responseData && (
                      <div className='space-y-2'>
                        <div className='text-sm font-medium text-blue-600 dark:text-blue-400'>
                          响应结果 (Response)
                        </div>
                        <div className='rounded-md border border-blue-200 bg-blue-50 p-3 dark:border-blue-800 dark:bg-blue-950/20'>
                          <pre className='overflow-x-auto font-mono text-xs whitespace-pre-wrap'>
                            {vulnerability.responseData}
                          </pre>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              </>
            )}
          </TabsContent>

          {/* 文档资料 */}
          <TabsContent value='documents' className='mt-6 space-y-6'>
            <div className='space-y-6'>
              {/* 修复建议 */}
              <div className='space-y-4'>
                <div className='flex items-center gap-2'>
                  <FileText className='text-muted-foreground h-4 w-4' />
                  <h3 className='text-lg font-semibold'>修复建议</h3>
                </div>
                {vulnerability.recommendation ? (
                  <div className='rounded-lg border border-green-200 bg-green-50 p-4 dark:border-green-800 dark:bg-green-950/20'>
                    <RichContentViewer content={vulnerability.recommendation} />
                  </div>
                ) : (
                  <div className='text-muted-foreground text-sm italic'>
                    修复建议待完善
                  </div>
                )}
              </div>

              <Separator />

              {/* 临时解决方案 */}
              <div className='space-y-4'>
                <h4 className='font-medium'>临时解决方案</h4>
                {vulnerability.workaround ? (
                  <div className='rounded-lg border border-yellow-200 bg-yellow-50 p-4 dark:border-yellow-800 dark:bg-yellow-950/20'>
                    <RichContentViewer content={vulnerability.workaround} />
                  </div>
                ) : (
                  <div className='text-muted-foreground text-sm italic'>
                    暂无临时解决方案
                  </div>
                )}
              </div>

              <Separator />

              {/* 参考资料 */}
              <div className='space-y-4'>
                <h4 className='font-medium'>参考资料</h4>
                {vulnerability.references ? (
                  <div className='bg-muted/30 rounded-lg border p-4'>
                    <RichContentViewer content={vulnerability.references} />
                  </div>
                ) : (
                  <div className='text-muted-foreground text-sm italic'>
                    暂无参考资料
                  </div>
                )}
              </div>
            </div>
          </TabsContent>

          {/* 协作记录 */}
          <TabsContent value='collaboration' className='mt-6 space-y-6'>
            <div className='space-y-6'>
              {/* 人员信息 */}
              <div className='space-y-4'>
                <div className='flex items-center gap-2'>
                  <Users className='text-muted-foreground h-4 w-4' />
                  <h3 className='text-lg font-semibold'>参与人员</h3>
                </div>

                <div className='grid gap-4 sm:grid-cols-2 lg:grid-cols-3'>
                  {/* 发现人员 */}
                  <div className='rounded-lg border p-4'>
                    <div className='mb-2 flex items-center gap-3'>
                      <div className='flex h-8 w-8 items-center justify-center rounded-full bg-blue-100 dark:bg-blue-900/20'>
                        <Eye className='h-4 w-4 text-blue-600 dark:text-blue-400' />
                      </div>
                      <div>
                        <div className='text-sm font-medium'>发现人员</div>
                        <div className='text-muted-foreground text-xs'>
                          {vulnerability.foundByUser
                            ? vulnerability.foundByUser.name ||
                              vulnerability.foundByUser.email
                            : '系统记录'}
                        </div>
                      </div>
                    </div>
                    <div className='text-muted-foreground text-xs'>
                      发现时间：
                      {new Date(vulnerability.foundDate).toLocaleString(
                        'zh-CN'
                      )}
                    </div>
                  </div>

                  {/* 确认人员 */}
                  {vulnerability.confirmedByUser && (
                    <div className='rounded-lg border p-4'>
                      <div className='mb-2 flex items-center gap-3'>
                        <div className='flex h-8 w-8 items-center justify-center rounded-full bg-green-100 dark:bg-green-900/20'>
                          <Bug className='h-4 w-4 text-green-600 dark:text-green-400' />
                        </div>
                        <div>
                          <div className='text-sm font-medium'>确认人员</div>
                          <div className='text-muted-foreground text-xs'>
                            {vulnerability.confirmedByUser.name ||
                              vulnerability.confirmedByUser.email}
                          </div>
                        </div>
                      </div>
                      {vulnerability.confirmedAt && (
                        <div className='text-muted-foreground text-xs'>
                          确认时间：
                          {new Date(vulnerability.confirmedAt).toLocaleString(
                            'zh-CN'
                          )}
                        </div>
                      )}
                    </div>
                  )}

                  {/* 验证人员 */}
                  {vulnerability.verifiedByUser && (
                    <div className='rounded-lg border p-4'>
                      <div className='mb-2 flex items-center gap-3'>
                        <div className='flex h-8 w-8 items-center justify-center rounded-full bg-purple-100 dark:bg-purple-900/20'>
                          <Network className='h-4 w-4 text-purple-600 dark:text-purple-400' />
                        </div>
                        <div>
                          <div className='text-sm font-medium'>验证人员</div>
                          <div className='text-muted-foreground text-xs'>
                            {vulnerability.verifiedByUser.name ||
                              vulnerability.verifiedByUser.email}
                          </div>
                        </div>
                      </div>
                      {vulnerability.verifiedAt && (
                        <div className='text-muted-foreground text-xs'>
                          验证时间：
                          {new Date(vulnerability.verifiedAt).toLocaleString(
                            'zh-CN'
                          )}
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>

              <Separator />

              {/* 状态变更历史 */}
              <div className='space-y-4'>
                <h4 className='flex items-center gap-2 font-medium'>
                  <MessageSquare className='h-4 w-4' />
                  状态变更历史
                </h4>
                <div className='space-y-3'>
                  {/* 这里应该是从后端获取的状态变更历史，现在显示基本信息 */}
                  <div className='flex items-start gap-3 rounded-lg border p-3'>
                    <div className='mt-2 h-2 w-2 rounded-full bg-green-500'></div>
                    <div className='flex-1'>
                      <div className='text-sm font-medium'>漏洞发现</div>
                      <div className='text-muted-foreground text-xs'>
                        {new Date(vulnerability.foundDate).toLocaleString(
                          'zh-CN'
                        )}{' '}
                        •
                        {vulnerability.foundByUser
                          ? ` ${vulnerability.foundByUser.name || vulnerability.foundByUser.email}`
                          : ' 系统记录'}
                      </div>
                    </div>
                  </div>

                  {vulnerability.confirmedAt && (
                    <div className='flex items-start gap-3 rounded-lg border p-3'>
                      <div className='mt-2 h-2 w-2 rounded-full bg-blue-500'></div>
                      <div className='flex-1'>
                        <div className='text-sm font-medium'>漏洞确认</div>
                        <div className='text-muted-foreground text-xs'>
                          {new Date(vulnerability.confirmedAt).toLocaleString(
                            'zh-CN'
                          )}{' '}
                          •
                          {vulnerability.confirmedByUser?.name ||
                            vulnerability.confirmedByUser?.email ||
                            '系统'}
                        </div>
                      </div>
                    </div>
                  )}

                  {vulnerability.fixedAt && (
                    <div className='flex items-start gap-3 rounded-lg border p-3'>
                      <div className='mt-2 h-2 w-2 rounded-full bg-orange-500'></div>
                      <div className='flex-1'>
                        <div className='text-sm font-medium'>漏洞修复</div>
                        <div className='text-muted-foreground text-xs'>
                          {new Date(vulnerability.fixedAt).toLocaleString(
                            'zh-CN'
                          )}
                        </div>
                      </div>
                    </div>
                  )}

                  {vulnerability.verifiedAt && (
                    <div className='flex items-start gap-3 rounded-lg border p-3'>
                      <div className='mt-2 h-2 w-2 rounded-full bg-purple-500'></div>
                      <div className='flex-1'>
                        <div className='text-sm font-medium'>漏洞验证</div>
                        <div className='text-muted-foreground text-xs'>
                          {new Date(vulnerability.verifiedAt).toLocaleString(
                            'zh-CN'
                          )}{' '}
                          •
                          {vulnerability.verifiedByUser?.name ||
                            vulnerability.verifiedByUser?.email ||
                            '系统'}
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </div>

              {/* 评论活动统计 */}
              {commentStats && (
                <>
                  <Separator />
                  <div className='space-y-4'>
                    <h4 className='flex items-center gap-2 font-medium'>
                      <MessageSquare className='h-4 w-4' />
                      讨论统计
                    </h4>

                    <div className='grid grid-cols-2 gap-4 sm:grid-cols-4'>
                      <div className='bg-muted/30 rounded-lg p-3 text-center'>
                        <div className='text-lg font-semibold'>
                          {commentStats.total}
                        </div>
                        <div className='text-muted-foreground text-xs'>
                          总评论数
                        </div>
                      </div>

                      <div className='bg-muted/30 rounded-lg p-3 text-center'>
                        <div className='text-lg font-semibold'>
                          {commentStats.participants}
                        </div>
                        <div className='text-muted-foreground text-xs'>
                          参与人数
                        </div>
                      </div>

                      <div className='bg-muted/30 rounded-lg p-3 text-center'>
                        <div className='text-lg font-semibold'>
                          {commentStats.internal}
                        </div>
                        <div className='text-muted-foreground text-xs'>
                          内部评论
                        </div>
                      </div>

                      <div className='bg-muted/30 rounded-lg p-3 text-center'>
                        <div className='text-lg font-semibold'>
                          {commentStats.replies}
                        </div>
                        <div className='text-muted-foreground text-xs'>
                          回复数量
                        </div>
                      </div>
                    </div>

                    {commentStats.lastCommentAt && (
                      <div className='text-muted-foreground text-center text-sm'>
                        最后评论时间：
                        {new Date(commentStats.lastCommentAt).toLocaleString(
                          'zh-CN'
                        )}
                      </div>
                    )}
                  </div>
                </>
              )}
            </div>
          </TabsContent>
        </Tabs>
      </CardContent>
    </Card>
  );
}
