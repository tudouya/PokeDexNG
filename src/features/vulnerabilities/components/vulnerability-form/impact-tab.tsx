'use client';

import { UseFormReturn } from 'react-hook-form';
import {
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage
} from '@/components/ui/form';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue
} from '@/components/ui/select';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { RichTextEditor } from '@/components/ui/rich-text-editor';
import { Separator } from '@/components/ui/separator';
import { TrendingUp, Users, Database, Calculator } from 'lucide-react';
import { CreateVulnerabilityInput } from '../../validations/vulnerability.validation';
import {
  BUSINESS_IMPACT_OPTIONS,
  DATA_EXPOSURE_OPTIONS,
  EXPLOITABILITY_OPTIONS,
  CVSS_VERSION_OPTIONS
} from '../vulnerability-tables/options';

interface ImpactTabProps {
  form: UseFormReturn<CreateVulnerabilityInput>;
}

export function ImpactTab({ form }: ImpactTabProps) {
  return (
    <div className='space-y-8'>
      {/* 影响评估区块 */}
      <div className='space-y-6'>
        <div>
          <h3 className='flex items-center gap-2 text-lg font-medium'>
            <TrendingUp className='h-5 w-5' />
            影响评估
          </h3>
          <p className='text-muted-foreground text-sm'>
            评估漏洞的技术和业务影响程度
          </p>
        </div>
        <Separator />

        {/* 技术影响描述 */}
        <FormField
          control={form.control}
          name='impact'
          render={({ field }) => (
            <FormItem>
              <FormLabel>技术影响描述</FormLabel>
              <FormControl>
                <RichTextEditor
                  content={field.value}
                  placeholder='详细描述漏洞可能造成的技术影响，支持插入影响范围图表或截图'
                  onChange={field.onChange}
                  minHeight='180px'
                />
              </FormControl>
              <FormDescription>
                从技术角度分析漏洞的具体危害，支持富文本格式和图片
              </FormDescription>
              <FormMessage />
            </FormItem>
          )}
        />

        <div className='grid grid-cols-1 gap-6 md:grid-cols-2'>
          {/* 业务影响级别 */}
          <FormField
            control={form.control}
            name='businessImpact'
            render={({ field }) => (
              <FormItem>
                <FormLabel>业务影响级别</FormLabel>
                <Select
                  onValueChange={field.onChange}
                  value={field.value || ''}
                >
                  <FormControl>
                    <SelectTrigger>
                      <SelectValue placeholder='选择业务影响级别' />
                    </SelectTrigger>
                  </FormControl>
                  <SelectContent>
                    {BUSINESS_IMPACT_OPTIONS.map((option) => (
                      <SelectItem key={option.value} value={option.value}>
                        <div className='flex items-center gap-2'>
                          <div
                            className='h-2 w-2 rounded-full'
                            style={{ backgroundColor: option.color }}
                          />
                          {option.label}
                        </div>
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
                <FormDescription>评估对业务运行的影响程度</FormDescription>
                <FormMessage />
              </FormItem>
            )}
          />

          {/* 数据暴露级别 */}
          <FormField
            control={form.control}
            name='dataExposure'
            render={({ field }) => (
              <FormItem>
                <FormLabel>数据暴露级别</FormLabel>
                <Select
                  onValueChange={field.onChange}
                  value={field.value || ''}
                >
                  <FormControl>
                    <SelectTrigger>
                      <SelectValue placeholder='选择数据暴露级别' />
                    </SelectTrigger>
                  </FormControl>
                  <SelectContent>
                    {DATA_EXPOSURE_OPTIONS.map((option) => (
                      <SelectItem key={option.value} value={option.value}>
                        <div className='flex items-center gap-2'>
                          <div
                            className='h-2 w-2 rounded-full'
                            style={{ backgroundColor: option.color }}
                          />
                          <div className='flex flex-col'>
                            <span className='text-sm'>{option.value}</span>
                            <span className='text-muted-foreground text-xs'>
                              {option.label}
                            </span>
                          </div>
                        </div>
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
                <FormDescription>可能泄露的数据类型和敏感程度</FormDescription>
                <FormMessage />
              </FormItem>
            )}
          />
        </div>

        {/* 影响用户数 */}
        <FormField
          control={form.control}
          name='affectedUsers'
          render={({ field }) => (
            <FormItem>
              <FormLabel>
                <div className='flex items-center gap-2'>
                  <Users className='h-4 w-4' />
                  影响用户数
                </div>
              </FormLabel>
              <FormControl>
                <Input
                  type='number'
                  placeholder='如：1000（预估受影响的用户数量）'
                  {...field}
                  onChange={(e) =>
                    field.onChange(
                      e.target.value ? parseInt(e.target.value) : undefined
                    )
                  }
                  value={field.value || ''}
                />
              </FormControl>
              <FormDescription>预估可能受到影响的用户数量</FormDescription>
              <FormMessage />
            </FormItem>
          )}
        />
      </div>

      {/* CVSS评分区块 */}
      <div className='space-y-6'>
        <div>
          <h3 className='flex items-center gap-2 text-lg font-medium'>
            <Calculator className='h-5 w-5' />
            CVSS评分
          </h3>
          <p className='text-muted-foreground text-sm'>
            使用通用漏洞评分系统进行标准化评估
          </p>
        </div>
        <Separator />

        <div className='grid grid-cols-1 gap-6 md:grid-cols-3'>
          {/* CVSS分数 */}
          <FormField
            control={form.control}
            name='cvssScore'
            render={({ field }) => (
              <FormItem>
                <FormLabel>CVSS分数</FormLabel>
                <FormControl>
                  <Input
                    type='number'
                    step='0.1'
                    min='0'
                    max='10'
                    placeholder='0.0 - 10.0'
                    {...field}
                    onChange={(e) =>
                      field.onChange(
                        e.target.value ? parseFloat(e.target.value) : undefined
                      )
                    }
                    value={field.value || ''}
                  />
                </FormControl>
                <FormDescription>0.0（无风险）到10.0（严重）</FormDescription>
                <FormMessage />
              </FormItem>
            )}
          />

          {/* CVSS版本 */}
          <FormField
            control={form.control}
            name='cvssVersion'
            render={({ field }) => (
              <FormItem>
                <FormLabel>CVSS版本</FormLabel>
                <Select
                  onValueChange={field.onChange}
                  defaultValue={field.value}
                >
                  <FormControl>
                    <SelectTrigger>
                      <SelectValue placeholder='选择CVSS版本' />
                    </SelectTrigger>
                  </FormControl>
                  <SelectContent>
                    {CVSS_VERSION_OPTIONS.map((option) => (
                      <SelectItem key={option.value} value={option.value}>
                        {option.label}
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
                <FormDescription>推荐使用CVSS 3.1</FormDescription>
                <FormMessage />
              </FormItem>
            )}
          />

          {/* 可利用性级别 */}
          <FormField
            control={form.control}
            name='exploitability'
            render={({ field }) => (
              <FormItem>
                <FormLabel>可利用性级别</FormLabel>
                <Select
                  onValueChange={field.onChange}
                  value={field.value || ''}
                >
                  <FormControl>
                    <SelectTrigger>
                      <SelectValue placeholder='选择可利用性' />
                    </SelectTrigger>
                  </FormControl>
                  <SelectContent>
                    {EXPLOITABILITY_OPTIONS.map((option) => (
                      <SelectItem key={option.value} value={option.value}>
                        <div className='flex items-center gap-2'>
                          <div
                            className='h-2 w-2 rounded-full'
                            style={{ backgroundColor: option.color }}
                          />
                          <div className='flex flex-col'>
                            <span className='text-sm'>{option.value}</span>
                            <span className='text-muted-foreground text-xs'>
                              {option.label}
                            </span>
                          </div>
                        </div>
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
                <FormDescription>当前漏洞的可利用程度</FormDescription>
                <FormMessage />
              </FormItem>
            )}
          />
        </div>

        {/* CVSS向量字符串 */}
        <FormField
          control={form.control}
          name='cvssVector'
          render={({ field }) => (
            <FormItem>
              <FormLabel>CVSS向量字符串</FormLabel>
              <FormControl>
                <Input
                  placeholder='如：CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H'
                  className='font-mono text-xs'
                  {...field}
                />
              </FormControl>
              <FormDescription>
                CVSS评分的向量表示，可用于重现评分过程
              </FormDescription>
              <FormMessage />
            </FormItem>
          )}
        />
      </div>
    </div>
  );
}
