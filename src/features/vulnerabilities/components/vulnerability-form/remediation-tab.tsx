'use client';

import { UseFormReturn } from 'react-hook-form';
import {
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage
} from '@/components/ui/form';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue
} from '@/components/ui/select';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { RichTextEditor } from '@/components/ui/rich-text-editor';
import { Separator } from '@/components/ui/separator';
import { Wrench, LifeBuoy, ExternalLink, Tags } from 'lucide-react';
import { CreateVulnerabilityInput } from '../../validations/vulnerability.validation';
import {
  OWASP_TOP_10_OPTIONS,
  COMMON_CWE_OPTIONS
} from '../vulnerability-tables/options';

interface RemediationTabProps {
  form: UseFormReturn<CreateVulnerabilityInput>;
}

export function RemediationTab({ form }: RemediationTabProps) {
  return (
    <div className='space-y-8'>
      {/* 修复方案区块 */}
      <div className='space-y-6'>
        <div>
          <h3 className='flex items-center gap-2 text-lg font-medium'>
            <Wrench className='h-5 w-5' />
            修复方案
          </h3>
          <p className='text-muted-foreground text-sm'>
            提供具体的修复建议和临时解决方案
          </p>
        </div>
        <Separator />

        {/* 修复建议 */}
        <FormField
          control={form.control}
          name='recommendation'
          render={({ field }) => (
            <FormItem>
              <FormLabel>修复建议</FormLabel>
              <FormControl>
                <RichTextEditor
                  content={field.value}
                  placeholder='提供详细的修复建议，支持有序列表、代码块等格式'
                  onChange={field.onChange}
                  minHeight='200px'
                />
              </FormControl>
              <FormDescription>
                支持富文本格式，提供具体、可操作的修复步骤和代码示例
              </FormDescription>
              <FormMessage />
            </FormItem>
          )}
        />

        {/* 临时解决方案 */}
        <FormField
          control={form.control}
          name='workaround'
          render={({ field }) => (
            <FormItem>
              <FormLabel>
                <div className='flex items-center gap-2'>
                  <LifeBuoy className='h-4 w-4' />
                  临时解决方案
                </div>
              </FormLabel>
              <FormControl>
                <RichTextEditor
                  content={field.value}
                  placeholder='在永久修复前可采取的临时措施，支持列表和代码格式'
                  onChange={field.onChange}
                  minHeight='160px'
                />
              </FormControl>
              <FormDescription>
                支持富文本格式，紧急情况下的临时缓解措施和配置示例
              </FormDescription>
              <FormMessage />
            </FormItem>
          )}
        />

        {/* 参考链接 */}
        <FormField
          control={form.control}
          name='references'
          render={({ field }) => (
            <FormItem>
              <FormLabel>
                <div className='flex items-center gap-2'>
                  <ExternalLink className='h-4 w-4' />
                  参考资料
                </div>
              </FormLabel>
              <FormControl>
                <RichTextEditor
                  content={field.value}
                  placeholder='相关的技术文档、修复指南、安全建议等，支持链接格式'
                  onChange={field.onChange}
                  minHeight='160px'
                />
              </FormControl>
              <FormDescription>
                支持富文本格式和链接，提供相关的技术文档和参考资料
              </FormDescription>
              <FormMessage />
            </FormItem>
          )}
        />
      </div>

      {/* 标准映射区块 */}
      <div className='space-y-6'>
        <div>
          <h3 className='flex items-center gap-2 text-lg font-medium'>
            <Tags className='h-5 w-5' />
            标准映射
          </h3>
          <p className='text-muted-foreground text-sm'>
            将漏洞映射到标准分类体系便于管理和报告
          </p>
        </div>
        <Separator />

        <div className='grid grid-cols-1 gap-6 md:grid-cols-2'>
          {/* CWE编号 */}
          <FormField
            control={form.control}
            name='cweId'
            render={({ field }) => (
              <FormItem>
                <FormLabel>CWE编号</FormLabel>
                <Select
                  onValueChange={field.onChange}
                  value={field.value || ''}
                >
                  <FormControl>
                    <SelectTrigger>
                      <SelectValue placeholder='选择CWE分类' />
                    </SelectTrigger>
                  </FormControl>
                  <SelectContent>
                    {COMMON_CWE_OPTIONS.map((option) => (
                      <SelectItem key={option.value} value={option.value}>
                        <div className='flex flex-col'>
                          <span className='text-sm'>{option.value}</span>
                          <span className='text-muted-foreground text-xs'>
                            {option.label}
                          </span>
                        </div>
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
                <FormDescription>
                  Common Weakness Enumeration 通用弱点枚举
                </FormDescription>
                <FormMessage />
              </FormItem>
            )}
          />

          {/* OWASP分类 */}
          <FormField
            control={form.control}
            name='owaspId'
            render={({ field }) => (
              <FormItem>
                <FormLabel>OWASP分类</FormLabel>
                <Select
                  onValueChange={field.onChange}
                  value={field.value || ''}
                >
                  <FormControl>
                    <SelectTrigger>
                      <SelectValue placeholder='选择OWASP Top 10' />
                    </SelectTrigger>
                  </FormControl>
                  <SelectContent>
                    {OWASP_TOP_10_OPTIONS.map((option) => (
                      <SelectItem key={option.value} value={option.value}>
                        <div className='flex flex-col'>
                          <span className='text-sm'>{option.value}</span>
                          <span className='text-muted-foreground text-xs'>
                            {option.label}
                          </span>
                        </div>
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
                <FormDescription>OWASP Top 10 Web应用安全风险</FormDescription>
                <FormMessage />
              </FormItem>
            )}
          />
        </div>

        {/* CVE编号 */}
        <FormField
          control={form.control}
          name='cveId'
          render={({ field }) => (
            <FormItem>
              <FormLabel>CVE编号</FormLabel>
              <FormControl>
                <Input
                  placeholder='如：CVE-2024-1234（已知漏洞编号）'
                  {...field}
                />
              </FormControl>
              <FormDescription>
                Common Vulnerabilities and Exposures 公共漏洞披露编号
              </FormDescription>
              <FormMessage />
            </FormItem>
          )}
        />
      </div>
    </div>
  );
}
