// VulnerabilityCategory基础类型
export interface VulnerabilityCategory {
  id: number;
  name: string;
  description: string | null;
  parentId: number | null;
  level: number;
  sort: number;
  isActive: boolean;
  isLeaf: boolean;
  createdAt: Date;
  updatedAt: Date;

  // 三层分类体系字段
  rootCause: string | null;
  technicalCategory: string | null;

  // 标准映射字段
  cweId: string | null;
  owaspCategory: string | null;

  // 知识库字段
  testingMethod: string | null;
  remediationTemplate: string | null;

  // 统计字段
  usageCount: number;
  lastUsedAt: Date | null;
}

// 带层级关系的分类类型
export interface VulnerabilityCategoryWithChildren
  extends VulnerabilityCategory {
  parent?: VulnerabilityCategory | null;
  children?: VulnerabilityCategory[];
}

// 创建分类DTO
export interface CreateCategoryDTO {
  name: string;
  description?: string;
  parentId?: number;
  sort?: number;
  rootCause?: string;
  technicalCategory?: string;
  cweId?: string;
  owaspCategory?: string;
  testingMethod?: string;
  remediationTemplate?: string;
}

// 更新分类DTO
export interface UpdateCategoryDTO {
  name?: string;
  description?: string;
  parentId?: number;
  sort?: number;
  isActive?: boolean;
  rootCause?: string;
  technicalCategory?: string;
  cweId?: string;
  owaspCategory?: string;
  testingMethod?: string;
  remediationTemplate?: string;
}

// 查询分类DTO
export interface FindCategoriesDTO {
  page?: number;
  limit?: number;
  parentId?: number | null; // 查询特定父分类的子分类
  level?: number; // 按层级过滤
  rootCause?: string; // 按根因过滤
  search?: string; // 搜索分类名称
  includeInactive?: boolean;
  withChildren?: boolean; // 是否包含子分类
}

// 分页结果类型
export interface PaginatedCategories {
  data: VulnerabilityCategory[];
  total: number;
  page: number;
  limit: number;
  totalPages: number;
}

// 分类统计类型
export interface CategoryStats {
  total: number;
  byLevel: Record<number, number>;
  byRootCause: Record<string, number>;
  withCWE: number;
  mostUsed: Array<{
    id: number;
    name: string;
    usageCount: number;
  }>;
}

// 分类树结构类型
export interface CategoryTreeNode {
  id: number;
  name: string;
  description: string | null;
  level: number;
  sort: number;
  isActive: boolean;
  isLeaf: boolean;
  cweId: string | null;
  owaspCategory: string | null;
  usageCount: number;
  children: CategoryTreeNode[];
}

// 5大根因分类枚举
export const ROOT_CAUSES = {
  INPUT_VALIDATION: '输入验证缺陷',
  ACCESS_CONTROL: '访问控制缺陷',
  INFO_DISCLOSURE: '信息暴露缺陷',
  CONTROL_FLOW: '控制流缺陷',
  CONFIG_MANAGEMENT: '配置管理缺陷'
} as const;

export type RootCause = keyof typeof ROOT_CAUSES;

// 常用技术分类
export const TECHNICAL_CATEGORIES = {
  INJECTION: '注入攻击',
  XSS: '跨站脚本',
  AUTHENTICATION: '身份认证',
  AUTHORIZATION: '权限控制',
  CRYPTO: '密码学',
  FILE_OPERATION: '文件操作',
  BUSINESS_LOGIC: '业务逻辑',
  INFORMATION_EXPOSURE: '信息泄露'
} as const;

export type TechnicalCategory = keyof typeof TECHNICAL_CATEGORIES;
