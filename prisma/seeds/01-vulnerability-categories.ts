import { PrismaClient } from '@prisma/client';
import * as fs from 'fs';
import * as path from 'path';

const prisma = new PrismaClient();

/**
 * åŸå§‹åˆ†ç±»æ•°æ®ç±»å‹ï¼ˆæ¥è‡ªJSONæ–‡ä»¶ï¼‰
 */
interface RawCategory {
  Id: number;
  Pid: number;
  Name: string;
  State: number;
}

/**
 * CWEæ˜ å°„æ•°æ®ç±»å‹
 */
interface CategoryMapping {
  rootCause?: string;
  technicalCategory?: string;
  cweId?: string;
  owaspCategory?: string;
  testingMethod?: string;
  remediation?: string;
}

/**
 * è½¬æ¢åçš„åˆ†ç±»ç±»å‹
 */
interface ConvertedCategory {
  id: number;
  name: string;
  description: string;
  parentId: number | null;
  level: number;
  sort: number;
  isActive: boolean;
  isLeaf: boolean;
  rootCause: string | null;
  technicalCategory: string | null;
  cweId: string | null;
  owaspCategory: string | null;
  testingMethod: string | null;
  remediationTemplate: string | null;
  usageCount: number;
  lastUsedAt: null;
}

/**
 * æ¼æ´åˆ†ç±»ç§å­æ•°æ®
 *
 * åŠŸèƒ½ï¼š
 * 1. å¯¼å…¥97ä¸ªæ¼æ´åˆ†ç±»ï¼ˆ7ä¸ªé¡¶å±‚ + 90ä¸ªå­åˆ†ç±»ï¼‰
 * 2. å»ºç«‹5å¤§æ ¹å› åˆ†ç±»æ˜ å°„
 * 3. æ·»åŠ CWEå’ŒOWASPæ ‡å‡†æ˜ å°„
 * 4. æ”¯æŒå¹‚ç­‰æ€§æ“ä½œï¼ˆå¯é‡å¤æ‰§è¡Œï¼‰
 */

/**
 * ç›´æ¥ä½¿ç”¨åŸå§‹æ•°å­—IDï¼Œæ— éœ€è½¬æ¢
 */

/**
 * æ ¹æ®åˆ†ç±»åç§°ç”Ÿæˆé»˜è®¤æè¿°
 */
function generateDescription(name: string, parentName?: string): string {
  const descriptions: Record<string, string> = {
    WEBæ¼æ´: 'Webåº”ç”¨ç¨‹åºç›¸å…³çš„å®‰å…¨æ¼æ´',
    PCå®¢æˆ·ç«¯æ¼æ´: 'PCå®¢æˆ·ç«¯è½¯ä»¶ç›¸å…³çš„å®‰å…¨æ¼æ´',
    ç§»åŠ¨åŠIOTæ™ºèƒ½: 'ç§»åŠ¨åº”ç”¨å’Œç‰©è”ç½‘è®¾å¤‡ç›¸å…³çš„å®‰å…¨æ¼æ´',
    æœåŠ¡å™¨æ¼æ´: 'æœåŠ¡å™¨ç³»ç»Ÿå’ŒæœåŠ¡ç›¸å…³çš„å®‰å…¨æ¼æ´',
    æŠ€æœ¯æƒ…æŠ¥: 'å®‰å…¨æŠ€æœ¯æƒ…æŠ¥å’Œå¨èƒä¿¡æ¯',
    ä¸šåŠ¡æƒ…æŠ¥: 'ä¸šåŠ¡å®‰å…¨ç›¸å…³çš„æƒ…æŠ¥ä¿¡æ¯',
    SQLæ³¨å…¥: 'é€šè¿‡åœ¨åº”ç”¨ç¨‹åºè¾“å…¥ä¸­æ³¨å…¥æ¶æ„SQLè¯­å¥ï¼Œè·å–æœªæˆæƒçš„æ•°æ®è®¿é—®',
    åå°„å‹XSS: 'è·¨ç«™è„šæœ¬æ”»å‡»ï¼Œæ¶æ„è„šæœ¬åœ¨ç”¨æˆ·æµè§ˆå™¨ä¸­æ‰§è¡Œä½†ä¸å­˜å‚¨åœ¨æœåŠ¡å™¨',
    å­˜å‚¨å‹XSS: 'è·¨ç«™è„šæœ¬æ”»å‡»ï¼Œæ¶æ„è„šæœ¬å­˜å‚¨åœ¨æœåŠ¡å™¨å¹¶åœ¨å…¶ä»–ç”¨æˆ·è®¿é—®æ—¶æ‰§è¡Œ',
    å‘½ä»¤æ³¨å…¥: 'é€šè¿‡æ³¨å…¥ç³»ç»Ÿå‘½ä»¤è·å–æœåŠ¡å™¨æ§åˆ¶æƒ',
    å‘½ä»¤æ‰§è¡Œ: 'ç›´æ¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤çš„å®‰å…¨æ¼æ´',
    ä»£ç æ‰§è¡Œ: 'æ‰§è¡Œä»»æ„ä»£ç çš„å®‰å…¨æ¼æ´',
    XXEæ³¨å…¥: 'XMLå¤–éƒ¨å®ä½“æ³¨å…¥ï¼Œå¯å¯¼è‡´æ–‡ä»¶è¯»å–æˆ–SSRF',
    SSRF: 'æœåŠ¡ç«¯è¯·æ±‚ä¼ªé€ ï¼Œè¯±ä½¿æœåŠ¡å™¨è®¿é—®å†…éƒ¨èµ„æº',
    æ–‡ä»¶ä¸Šä¼ : 'ä¸å®‰å…¨çš„æ–‡ä»¶ä¸Šä¼ å¯èƒ½å¯¼è‡´ä»£ç æ‰§è¡Œ',
    æ–‡ä»¶åŒ…å«: 'åŒ…å«æ¶æ„æ–‡ä»¶å¯¼è‡´ä»£ç æ‰§è¡Œ',
    æ–‡ä»¶è¯»å–: 'æœªæˆæƒè¯»å–æœåŠ¡å™¨æ–‡ä»¶',
    ç›®å½•éå†: 'é€šè¿‡è·¯å¾„éå†è®¿é—®å—é™ç›®å½•',
    CSRF: 'è·¨ç«™è¯·æ±‚ä¼ªé€ ï¼Œè¯±ä½¿ç”¨æˆ·æ‰§è¡Œéé¢„æœŸæ“ä½œ',
    ä¿¡æ¯æ³„éœ²: 'æ•æ„Ÿä¿¡æ¯çš„ä¸å½“æš´éœ²',
    è¶ŠæƒæŸ¥è¯¢æ¼æ´: 'æœªç»æˆæƒæŸ¥è¯¢å…¶ä»–ç”¨æˆ·æ•°æ®',
    è¶Šæƒåˆ é™¤æ¼æ´: 'æœªç»æˆæƒåˆ é™¤å…¶ä»–ç”¨æˆ·æ•°æ®',
    è¶Šæƒä¿®æ”¹æ¼æ´: 'æœªç»æˆæƒä¿®æ”¹å…¶ä»–ç”¨æˆ·æ•°æ®',
    è¶Šæƒæ–°å¢æ¼æ´: 'æœªç»æˆæƒä¸ºå…¶ä»–ç”¨æˆ·åˆ›å»ºæ•°æ®',
    å‚ç›´è¶Šæƒæ¼æ´: 'ä½æƒé™ç”¨æˆ·è®¿é—®é«˜æƒé™åŠŸèƒ½',
    å¼±å£ä»¤: 'ä½¿ç”¨å®¹æ˜“çŒœæµ‹çš„å¯†ç ',
    ååºåˆ—åŒ–: 'ä¸å®‰å…¨çš„ååºåˆ—åŒ–å¯èƒ½å¯¼è‡´è¿œç¨‹ä»£ç æ‰§è¡Œ',
    URLè·³è½¬: 'å¼€æ”¾é‡å®šå‘æ¼æ´ï¼Œå¯ç”¨äºé’“é±¼æ”»å‡»',
    é€»è¾‘æ¼æ´: 'ä¸šåŠ¡é€»è¾‘è®¾è®¡æˆ–å®ç°ç¼ºé™·',
    çŸ­ä¿¡è½°ç‚¸æ¼æ´: 'çŸ­ä¿¡å‘é€æ¥å£ç¼ºå°‘é¢‘ç‡é™åˆ¶',
    æ”¯ä»˜æ¼æ´: 'æ”¯ä»˜æµç¨‹çš„å®‰å…¨ç¼ºé™·',
    æ¡ä»¶ç«äº‰æ¼æ´: 'å¹¶å‘æ“ä½œå¯¼è‡´çš„å®‰å…¨é—®é¢˜'
  };

  if (descriptions[name]) {
    return descriptions[name];
  }

  // ç”Ÿæˆé»˜è®¤æè¿°
  if (parentName) {
    return `${parentName}ä¸­çš„${name}ç›¸å…³å®‰å…¨æ¼æ´`;
  }
  return `${name}ç›¸å…³çš„å®‰å…¨æ¼æ´æˆ–å®‰å…¨é—®é¢˜`;
}

/**
 * æ‰§è¡Œæ¼æ´åˆ†ç±»ç§å­æ•°æ®
 */
export async function seedVulnerabilityCategories() {
  console.log('ğŸ”„ å¼€å§‹å¯¼å…¥æ¼æ´åˆ†ç±»æ•°æ®...');

  try {
    // è¯»å–åŸå§‹åˆ†ç±»æ•°æ®
    const rawDataPath = path.join(
      __dirname,
      'data',
      'vulnerability-categories.json'
    );
    const rawData = JSON.parse(fs.readFileSync(rawDataPath, 'utf-8'));

    // è¯»å–CWEæ˜ å°„æ•°æ®
    const mappingPath = path.join(
      __dirname,
      'data',
      'category-cwe-mappings.json'
    );
    const cweMappings = JSON.parse(fs.readFileSync(mappingPath, 'utf-8'));

    // éªŒè¯æ•°æ®
    if (!rawData.data || !Array.isArray(rawData.data)) {
      throw new Error('æ— æ•ˆçš„åˆ†ç±»æ•°æ®æ ¼å¼');
    }

    const categories = rawData.data;
    console.log(`  ğŸ“Š æ‰¾åˆ° ${categories.length} ä¸ªåˆ†ç±»`);

    // å»ºç«‹åç§°åˆ°çˆ¶åç§°çš„æ˜ å°„
    const nameToParentName = new Map<string, string>();
    categories.forEach((cat: RawCategory) => {
      if (cat.Pid !== 0) {
        const parent = categories.find((p: RawCategory) => p.Id === cat.Pid);
        if (parent) {
          nameToParentName.set(cat.Name, parent.Name);
        }
      }
    });

    // è½¬æ¢æ•°æ®æ ¼å¼
    const convertedCategories = categories.map((cat: RawCategory) => {
      const parentName = nameToParentName.get(cat.Name);
      const mapping: CategoryMapping = cweMappings[cat.Name] || {};

      return {
        id: cat.Id,
        name: cat.Name,
        description: generateDescription(cat.Name, parentName),
        parentId: cat.Pid === 0 ? null : cat.Pid,
        level: cat.Pid === 0 ? 1 : 2, // ç®€åŒ–å¤„ç†ï¼Œåªæœ‰ä¸¤å±‚
        sort: cat.Id, // ä½¿ç”¨åŸå§‹IDä½œä¸ºæ’åºå€¼
        isActive: cat.State === 1,
        isLeaf: !categories.some((c: RawCategory) => c.Pid === cat.Id), // æ²¡æœ‰å­åˆ†ç±»åˆ™ä¸ºå¶å­èŠ‚ç‚¹

        // æ˜ å°„å­—æ®µ
        rootCause: mapping.rootCause || null,
        technicalCategory: mapping.technicalCategory || null,
        cweId: mapping.cweId || null,
        owaspCategory: mapping.owaspCategory || null,
        testingMethod: mapping.testingMethod || null,
        remediationTemplate: mapping.remediation || null,

        // ç»Ÿè®¡å­—æ®µ
        usageCount: 0,
        lastUsedAt: null
      };
    });

    // åˆ†ç¦»é¡¶å±‚å’Œå­åˆ†ç±»
    const topLevelCategories = convertedCategories.filter(
      (c: ConvertedCategory) => c.parentId === null
    );
    const childCategories = convertedCategories.filter(
      (c: ConvertedCategory) => c.parentId !== null
    );

    console.log(`  ğŸ“ é¡¶å±‚åˆ†ç±»: ${topLevelCategories.length} ä¸ª`);
    console.log(`  ğŸ“‚ å­åˆ†ç±»: ${childCategories.length} ä¸ª`);

    // ä½¿ç”¨äº‹åŠ¡æ‰§è¡Œæ•°æ®æ“ä½œ
    const result = await prisma.$transaction(async (tx) => {
      // 1. åˆ é™¤æ‰€æœ‰ç°æœ‰åˆ†ç±»ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
      const deleted = await tx.vulnerabilityCategory.deleteMany();
      console.log(`  ğŸ—‘ï¸  åˆ é™¤äº† ${deleted.count} ä¸ªæ—§åˆ†ç±»`);

      // 2. æ‰¹é‡æ’å…¥é¡¶å±‚åˆ†ç±»
      const topResult = await tx.vulnerabilityCategory.createMany({
        data: topLevelCategories,
        skipDuplicates: true
      });
      console.log(`  âœ… åˆ›å»ºäº† ${topResult.count} ä¸ªé¡¶å±‚åˆ†ç±»`);

      // 3. æ‰¹é‡æ’å…¥å­åˆ†ç±»
      const childResult = await tx.vulnerabilityCategory.createMany({
        data: childCategories,
        skipDuplicates: true
      });
      console.log(`  âœ… åˆ›å»ºäº† ${childResult.count} ä¸ªå­åˆ†ç±»`);

      return {
        topLevel: topResult.count,
        children: childResult.count,
        total: topResult.count + childResult.count
      };
    });

    // ç»Ÿè®¡æ˜ å°„æƒ…å†µ
    const mappedCategories = convertedCategories.filter(
      (c: ConvertedCategory) => c.cweId !== null
    );
    const rootCauseCategories = convertedCategories.filter(
      (c: ConvertedCategory) => c.rootCause !== null
    );

    console.log('\nğŸ“Š å¯¼å…¥ç»Ÿè®¡:');
    console.log(`  ğŸ“ æ€»åˆ†ç±»æ•°: ${result.total}`);
    console.log(`  ğŸ”— CWEæ˜ å°„: ${mappedCategories.length} ä¸ª`);
    console.log(`  ğŸ¯ æ ¹å› æ˜ å°„: ${rootCauseCategories.length} ä¸ª`);

    // æ˜¾ç¤º5å¤§æ ¹å› åˆ†å¸ƒ
    const rootCauseStats = new Map<string, number>();
    rootCauseCategories.forEach((cat: ConvertedCategory) => {
      const count = rootCauseStats.get(cat.rootCause!) || 0;
      rootCauseStats.set(cat.rootCause!, count + 1);
    });

    console.log('\nğŸ¯ æ ¹å› åˆ†ç±»åˆ†å¸ƒ:');
    Array.from(rootCauseStats.entries())
      .sort((a, b) => b[1] - a[1])
      .forEach(([cause, count]) => {
        const percentage = ((count / rootCauseCategories.length) * 100).toFixed(
          1
        );
        console.log(`  â€¢ ${cause}: ${count} ä¸ª (${percentage}%)`);
      });

    console.log('\nâœ… æ¼æ´åˆ†ç±»æ•°æ®å¯¼å…¥å®Œæˆï¼');

    return {
      success: true,
      total: result.total,
      mapped: mappedCategories.length,
      rootCause: rootCauseCategories.length
    };
  } catch (error: any) {
    console.error('âŒ æ¼æ´åˆ†ç±»æ•°æ®å¯¼å…¥å¤±è´¥:', error.message);
    throw error;
  }
}

/**
 * éªŒè¯åˆ†ç±»æ•°æ®å®Œæ•´æ€§
 */
export async function validateCategories() {
  console.log('ğŸ” éªŒè¯åˆ†ç±»æ•°æ®å®Œæ•´æ€§...');

  try {
    // æ£€æŸ¥åˆ†ç±»æ€»æ•°
    const totalCount = await prisma.vulnerabilityCategory.count();
    console.log(`  ğŸ“Š åˆ†ç±»æ€»æ•°: ${totalCount}`);

    // æ£€æŸ¥é¡¶å±‚åˆ†ç±»
    const topLevel = await prisma.vulnerabilityCategory.count({
      where: { parentId: null }
    });
    console.log(`  ğŸ“ é¡¶å±‚åˆ†ç±»: ${topLevel}`);

    // æ£€æŸ¥æœ‰CWEæ˜ å°„çš„åˆ†ç±»
    const withCWE = await prisma.vulnerabilityCategory.count({
      where: { cweId: { not: null } }
    });
    console.log(`  ğŸ”— CWEæ˜ å°„: ${withCWE}`);

    // æ£€æŸ¥æœ‰æ ¹å› æ˜ å°„çš„åˆ†ç±»
    const withRootCause = await prisma.vulnerabilityCategory.count({
      where: { rootCause: { not: null } }
    });
    console.log(`  ğŸ¯ æ ¹å› æ˜ å°„: ${withRootCause}`);

    // æ£€æŸ¥å­¤ç«‹åˆ†ç±»ï¼ˆparentIdæŒ‡å‘ä¸å­˜åœ¨çš„åˆ†ç±»ï¼‰
    const categories = await prisma.vulnerabilityCategory.findMany({
      select: { id: true, parentId: true, name: true }
    });

    const idSet = new Set(categories.map((c) => c.id));
    const orphans = categories.filter(
      (c) => c.parentId && !idSet.has(c.parentId)
    );

    if (orphans.length > 0) {
      console.log(`  âš ï¸  å‘ç° ${orphans.length} ä¸ªå­¤ç«‹åˆ†ç±»:`);
      orphans.forEach((o) => {
        console.log(`    - ${o.name} (parentId: ${o.parentId})`);
      });
    } else {
      console.log(`  âœ… æ‰€æœ‰åˆ†ç±»å±‚çº§å…³ç³»æ­£ç¡®`);
    }

    return {
      total: totalCount,
      topLevel,
      withCWE,
      withRootCause,
      orphans: orphans.length,
      isValid: orphans.length === 0 && totalCount > 0
    };
  } catch (error: any) {
    console.error('âŒ éªŒè¯å¤±è´¥:', error.message);
    return {
      isValid: false,
      error: error.message
    };
  }
}

// å¦‚æœç›´æ¥è¿è¡Œæ­¤æ–‡ä»¶
if (require.main === module) {
  seedVulnerabilityCategories()
    .then(() => validateCategories())
    .finally(() => prisma.$disconnect());
}
