-- CreateTable
CREATE TABLE `vulnerabilities` (
    `id` INTEGER NOT NULL AUTO_INCREMENT,
    `title` VARCHAR(500) NOT NULL,
    `description` TEXT NOT NULL,
    `severity` ENUM('CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFO') NOT NULL,
    `status` ENUM('OPEN', 'CONFIRMED', 'IN_PROGRESS', 'FIXED', 'VERIFIED', 'REOPEN', 'WONT_FIX', 'FALSE_POSITIVE', 'DUPLICATE', 'ACCEPTED_RISK') NOT NULL DEFAULT 'OPEN',
    `target_id` INTEGER NOT NULL,
    `category_id` INTEGER NULL,
    `template_id` INTEGER NULL,
    `found_date` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
    `due_date` DATETIME(3) NULL,
    `confirmed_at` DATETIME(3) NULL,
    `fixed_at` DATETIME(3) NULL,
    `verified_at` DATETIME(3) NULL,
    `affected_module` VARCHAR(500) NULL,
    `affected_parameter` VARCHAR(500) NULL,
    `affected_url` VARCHAR(1000) NULL,
    `affected_endpoint` VARCHAR(500) NULL,
    `reproduction_steps` TEXT NULL,
    `proof_of_concept` TEXT NULL,
    `request_data` TEXT NULL,
    `response_data` TEXT NULL,
    `impact` TEXT NULL,
    `business_impact` ENUM('CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'NONE') NULL,
    `affected_users` INTEGER NULL,
    `data_exposure` ENUM('SENSITIVE', 'PII', 'INTERNAL', 'PUBLIC', 'NONE') NULL,
    `recommendation` TEXT NULL,
    `workaround` TEXT NULL,
    `references` TEXT NULL,
    `cvss_score` DOUBLE NULL,
    `cvss_vector` VARCHAR(200) NULL,
    `cvss_version` VARCHAR(10) NULL DEFAULT '3.1',
    `exploitability` ENUM('FUNCTIONAL', 'POC', 'THEORETICAL', 'UNKNOWN') NULL,
    `cwe_id` VARCHAR(20) NULL,
    `cve_id` VARCHAR(30) NULL,
    `owasp_id` VARCHAR(20) NULL,
    `found_by` INTEGER NOT NULL,
    `assigned_to` INTEGER NULL,
    `confirmed_by` INTEGER NULL,
    `verified_by` INTEGER NULL,
    `import_task_id` INTEGER NULL,
    `source_scanner` VARCHAR(50) NULL,
    `scanner_vuln_id` VARCHAR(100) NULL,
    `is_deleted` BOOLEAN NOT NULL DEFAULT false,
    `created_at` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
    `updated_at` DATETIME(3) NOT NULL,

    INDEX `vulnerabilities_target_id_is_deleted_idx`(`target_id`, `is_deleted`),
    INDEX `vulnerabilities_category_id_idx`(`category_id`),
    INDEX `vulnerabilities_template_id_idx`(`template_id`),
    INDEX `vulnerabilities_severity_status_idx`(`severity`, `status`),
    INDEX `vulnerabilities_status_found_date_idx`(`status`, `found_date`),
    INDEX `vulnerabilities_assigned_to_status_idx`(`assigned_to`, `status`),
    INDEX `vulnerabilities_found_by_idx`(`found_by`),
    INDEX `vulnerabilities_import_task_id_idx`(`import_task_id`),
    INDEX `vulnerabilities_cwe_id_idx`(`cwe_id`),
    PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- CreateTable
CREATE TABLE `vulnerability_templates` (
    `id` INTEGER NOT NULL AUTO_INCREMENT,
    `name` VARCHAR(255) NOT NULL,
    `code` VARCHAR(50) NOT NULL,
    `category_id` INTEGER NOT NULL,
    `title_template` VARCHAR(500) NOT NULL,
    `description_template` TEXT NOT NULL,
    `severity` ENUM('CRITICAL', 'HIGH', 'MEDIUM', 'LOW', 'INFO') NOT NULL DEFAULT 'MEDIUM',
    `impact` TEXT NULL,
    `recommendation` TEXT NULL,
    `references` TEXT NULL,
    `reproduction_steps` TEXT NULL,
    `default_cvss_vector` VARCHAR(200) NULL,
    `default_cvss_score` DOUBLE NULL,
    `cwe_id` VARCHAR(20) NULL,
    `owasp_id` VARCHAR(20) NULL,
    `is_active` BOOLEAN NOT NULL DEFAULT true,
    `usage_count` INTEGER NOT NULL DEFAULT 0,
    `last_used_at` DATETIME(3) NULL,
    `created_by` INTEGER NOT NULL,
    `created_at` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
    `updated_at` DATETIME(3) NOT NULL,

    UNIQUE INDEX `vulnerability_templates_name_key`(`name`),
    UNIQUE INDEX `vulnerability_templates_code_key`(`code`),
    INDEX `vulnerability_templates_category_id_idx`(`category_id`),
    INDEX `vulnerability_templates_is_active_usage_count_idx`(`is_active`, `usage_count`),
    PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- CreateTable
CREATE TABLE `vulnerability_status_history` (
    `id` INTEGER NOT NULL AUTO_INCREMENT,
    `vulnerability_id` INTEGER NOT NULL,
    `from_status` ENUM('OPEN', 'CONFIRMED', 'IN_PROGRESS', 'FIXED', 'VERIFIED', 'REOPEN', 'WONT_FIX', 'FALSE_POSITIVE', 'DUPLICATE', 'ACCEPTED_RISK') NULL,
    `to_status` ENUM('OPEN', 'CONFIRMED', 'IN_PROGRESS', 'FIXED', 'VERIFIED', 'REOPEN', 'WONT_FIX', 'FALSE_POSITIVE', 'DUPLICATE', 'ACCEPTED_RISK') NOT NULL,
    `changed_by` INTEGER NOT NULL,
    `change_reason` TEXT NULL,
    `changed_at` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),

    INDEX `vulnerability_status_history_vulnerability_id_changed_at_idx`(`vulnerability_id`, `changed_at`),
    PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- CreateTable
CREATE TABLE `vulnerability_comments` (
    `id` INTEGER NOT NULL AUTO_INCREMENT,
    `vulnerability_id` INTEGER NOT NULL,
    `parent_id` INTEGER NULL,
    `author_id` INTEGER NOT NULL,
    `content` TEXT NOT NULL,
    `is_internal` BOOLEAN NOT NULL DEFAULT false,
    `mentioned_users` JSON NULL,
    `created_at` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
    `updated_at` DATETIME(3) NOT NULL,
    `is_deleted` BOOLEAN NOT NULL DEFAULT false,

    INDEX `vulnerability_comments_vulnerability_id_is_deleted_idx`(`vulnerability_id`, `is_deleted`),
    INDEX `vulnerability_comments_parent_id_idx`(`parent_id`),
    PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- CreateTable
CREATE TABLE `vulnerability_attachments` (
    `id` INTEGER NOT NULL AUTO_INCREMENT,
    `vulnerability_id` INTEGER NOT NULL,
    `file_name` VARCHAR(255) NOT NULL,
    `original_name` VARCHAR(255) NOT NULL,
    `file_type` VARCHAR(50) NOT NULL,
    `mime_type` VARCHAR(100) NOT NULL,
    `file_size` INTEGER NOT NULL,
    `file_path` VARCHAR(1000) NOT NULL,
    `file_hash` VARCHAR(64) NULL,
    `attachment_type` ENUM('SCREENSHOT', 'VIDEO', 'EVIDENCE', 'POC_CODE', 'SCAN_REPORT', 'OTHER') NOT NULL DEFAULT 'EVIDENCE',
    `description` TEXT NULL,
    `uploaded_by` INTEGER NOT NULL,
    `uploaded_at` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
    `is_deleted` BOOLEAN NOT NULL DEFAULT false,

    INDEX `vulnerability_attachments_vulnerability_id_is_deleted_idx`(`vulnerability_id`, `is_deleted`),
    INDEX `vulnerability_attachments_attachment_type_idx`(`attachment_type`),
    PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- CreateTable
CREATE TABLE `vulnerability_tags` (
    `id` INTEGER NOT NULL AUTO_INCREMENT,
    `name` VARCHAR(50) NOT NULL,
    `slug` VARCHAR(50) NOT NULL,
    `color` VARCHAR(7) NOT NULL DEFAULT '#666666',
    `icon` VARCHAR(50) NULL,
    `description` TEXT NULL,
    `is_system` BOOLEAN NOT NULL DEFAULT false,
    `usage_count` INTEGER NOT NULL DEFAULT 0,
    `created_at` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),

    UNIQUE INDEX `vulnerability_tags_name_key`(`name`),
    UNIQUE INDEX `vulnerability_tags_slug_key`(`slug`),
    INDEX `vulnerability_tags_slug_idx`(`slug`),
    PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- CreateTable
CREATE TABLE `vulnerability_tag_mappings` (
    `id` INTEGER NOT NULL AUTO_INCREMENT,
    `vulnerability_id` INTEGER NOT NULL,
    `tag_id` INTEGER NOT NULL,
    `added_by` INTEGER NOT NULL,
    `added_at` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),

    INDEX `vulnerability_tag_mappings_tag_id_idx`(`tag_id`),
    UNIQUE INDEX `vulnerability_tag_mappings_vulnerability_id_tag_id_key`(`vulnerability_id`, `tag_id`),
    PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- CreateTable
CREATE TABLE `import_tasks` (
    `id` INTEGER NOT NULL AUTO_INCREMENT,
    `user_id` INTEGER NOT NULL,
    `target_id` INTEGER NOT NULL,
    `file_name` VARCHAR(500) NOT NULL,
    `file_type` VARCHAR(50) NOT NULL,
    `file_size` INTEGER NOT NULL,
    `file_path` VARCHAR(1000) NULL,
    `status` ENUM('PENDING', 'UPLOADING', 'PARSING', 'VALIDATING', 'IMPORTING', 'COMPLETED', 'FAILED', 'CANCELLED') NOT NULL DEFAULT 'PENDING',
    `progress` INTEGER NOT NULL DEFAULT 0,
    `total_items` INTEGER NULL,
    `processed_items` INTEGER NULL,
    `success_items` INTEGER NULL,
    `failed_items` INTEGER NULL,
    `duplicate_items` INTEGER NULL,
    `mapping_rules` JSON NULL,
    `import_options` JSON NULL,
    `parse_result` JSON NULL,
    `error_log` JSON NULL,
    `summary` JSON NULL,
    `created_at` DATETIME(3) NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
    `started_at` DATETIME(3) NULL,
    `completed_at` DATETIME(3) NULL,

    INDEX `import_tasks_user_id_status_idx`(`user_id`, `status`),
    INDEX `import_tasks_target_id_idx`(`target_id`),
    INDEX `import_tasks_status_created_at_idx`(`status`, `created_at`),
    PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- AddForeignKey
ALTER TABLE `vulnerabilities` ADD CONSTRAINT `vulnerabilities_target_id_fkey` FOREIGN KEY (`target_id`) REFERENCES `targets`(`id`) ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE `vulnerabilities` ADD CONSTRAINT `vulnerabilities_category_id_fkey` FOREIGN KEY (`category_id`) REFERENCES `vulnerability_categories`(`id`) ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE `vulnerabilities` ADD CONSTRAINT `vulnerabilities_template_id_fkey` FOREIGN KEY (`template_id`) REFERENCES `vulnerability_templates`(`id`) ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE `vulnerabilities` ADD CONSTRAINT `vulnerabilities_import_task_id_fkey` FOREIGN KEY (`import_task_id`) REFERENCES `import_tasks`(`id`) ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE `vulnerabilities` ADD CONSTRAINT `vulnerabilities_found_by_fkey` FOREIGN KEY (`found_by`) REFERENCES `users`(`id`) ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE `vulnerabilities` ADD CONSTRAINT `vulnerabilities_assigned_to_fkey` FOREIGN KEY (`assigned_to`) REFERENCES `users`(`id`) ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE `vulnerabilities` ADD CONSTRAINT `vulnerabilities_confirmed_by_fkey` FOREIGN KEY (`confirmed_by`) REFERENCES `users`(`id`) ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE `vulnerabilities` ADD CONSTRAINT `vulnerabilities_verified_by_fkey` FOREIGN KEY (`verified_by`) REFERENCES `users`(`id`) ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE `vulnerability_templates` ADD CONSTRAINT `vulnerability_templates_category_id_fkey` FOREIGN KEY (`category_id`) REFERENCES `vulnerability_categories`(`id`) ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE `vulnerability_templates` ADD CONSTRAINT `vulnerability_templates_created_by_fkey` FOREIGN KEY (`created_by`) REFERENCES `users`(`id`) ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE `vulnerability_status_history` ADD CONSTRAINT `vulnerability_status_history_vulnerability_id_fkey` FOREIGN KEY (`vulnerability_id`) REFERENCES `vulnerabilities`(`id`) ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE `vulnerability_status_history` ADD CONSTRAINT `vulnerability_status_history_changed_by_fkey` FOREIGN KEY (`changed_by`) REFERENCES `users`(`id`) ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE `vulnerability_comments` ADD CONSTRAINT `vulnerability_comments_vulnerability_id_fkey` FOREIGN KEY (`vulnerability_id`) REFERENCES `vulnerabilities`(`id`) ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE `vulnerability_comments` ADD CONSTRAINT `vulnerability_comments_author_id_fkey` FOREIGN KEY (`author_id`) REFERENCES `users`(`id`) ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE `vulnerability_comments` ADD CONSTRAINT `vulnerability_comments_parent_id_fkey` FOREIGN KEY (`parent_id`) REFERENCES `vulnerability_comments`(`id`) ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE `vulnerability_attachments` ADD CONSTRAINT `vulnerability_attachments_vulnerability_id_fkey` FOREIGN KEY (`vulnerability_id`) REFERENCES `vulnerabilities`(`id`) ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE `vulnerability_attachments` ADD CONSTRAINT `vulnerability_attachments_uploaded_by_fkey` FOREIGN KEY (`uploaded_by`) REFERENCES `users`(`id`) ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE `vulnerability_tag_mappings` ADD CONSTRAINT `vulnerability_tag_mappings_vulnerability_id_fkey` FOREIGN KEY (`vulnerability_id`) REFERENCES `vulnerabilities`(`id`) ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE `vulnerability_tag_mappings` ADD CONSTRAINT `vulnerability_tag_mappings_tag_id_fkey` FOREIGN KEY (`tag_id`) REFERENCES `vulnerability_tags`(`id`) ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE `vulnerability_tag_mappings` ADD CONSTRAINT `vulnerability_tag_mappings_added_by_fkey` FOREIGN KEY (`added_by`) REFERENCES `users`(`id`) ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE `import_tasks` ADD CONSTRAINT `import_tasks_user_id_fkey` FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE RESTRICT ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE `import_tasks` ADD CONSTRAINT `import_tasks_target_id_fkey` FOREIGN KEY (`target_id`) REFERENCES `targets`(`id`) ON DELETE RESTRICT ON UPDATE CASCADE;
